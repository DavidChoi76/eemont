
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eemont.common &#8212; eemont 0.1.9 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.f6b7ca918bee2f46fd9abac01cfb07d5.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1e043a052b0af929e4d8.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">


    
      
      <a class="navbar-brand" href="../../index.html">
        <img src="../../_static/logo.png" class="logo" alt="logo">
      </a>
      
    

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    
    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../classes/index.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../guide/eemontR.html">
  Extensions
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../changelog.html">
  Changelog
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials.html">
  Tutorials
 </a>
</li>

        
      </ul>

      <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/davemlz/eemont" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/dmlmont" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    
</nav>


              
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for eemont.common</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ee</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">box</span> <span class="kn">import</span> <span class="n">Box</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

<span class="c1"># Platforms IDs</span>
<span class="c1"># --------------------------</span>


<span class="k">def</span> <span class="nf">_get_platform_STAC</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the platform (satellite) of an image (or image collection) and wheter if it is a Surface Reflectance product.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image or image collection to get the platform from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Platform and product of the image (or image collection).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eemontDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;eemont&quot;</span><span class="p">,</span> <span class="s2">&quot;eemont.py&quot;</span><span class="p">))</span>
    <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eemontDir</span><span class="p">,</span> <span class="s2">&quot;data/ee-catalog-ids.json&quot;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">)</span>
    <span class="n">eeDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">platforms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">ID</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

    <span class="n">plt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">eeDict</span><span class="p">[</span><span class="n">platform</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;image_collection&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">pltID</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">eeDict</span><span class="p">[</span><span class="n">platform</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">imagecollection</span><span class="o">.</span><span class="n">ImageCollection</span>
        <span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pltID</span> <span class="o">=</span> <span class="n">ID</span>

        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="n">pltID</span><span class="p">:</span>
            <span class="n">plt</span> <span class="o">=</span> <span class="n">pltID</span>

        <span class="k">if</span> <span class="s2">&quot;_SR&quot;</span> <span class="ow">in</span> <span class="n">pltID</span><span class="p">:</span>
            <span class="n">platformDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">plt</span><span class="p">,</span> <span class="s2">&quot;sr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">platformDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">plt</span><span class="p">,</span> <span class="s2">&quot;sr&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">plt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Sorry, satellite platform not supported!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">platformDict</span>


<span class="c1"># Spectral Indices</span>
<span class="c1"># --------------------------</span>


<span class="k">def</span> <span class="nf">_get_expression_map</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">platformDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the dictionary required for the map parameter in ee.Image.expression() method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : ee.Image</span>
<span class="sd">        Image to get the dictionary from.</span>
<span class="sd">    platformDict : dict</span>
<span class="sd">        Dictionary retrieved from the _get_platform() method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Map dictionary for ee.Image.expression.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">lookupS2</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B1&quot;</span><span class="p">),</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B3&quot;</span><span class="p">),</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B4&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RE1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B5&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RE2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B6&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RE3&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B7&quot;</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B8&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RE4&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B8A&quot;</span><span class="p">),</span>
            <span class="s2">&quot;WV&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B9&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B11&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B12&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">lookupL8</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B1&quot;</span><span class="p">),</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B3&quot;</span><span class="p">),</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B4&quot;</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B5&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B6&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B7&quot;</span><span class="p">),</span>
            <span class="s2">&quot;T1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B10&quot;</span><span class="p">),</span>
            <span class="s2">&quot;T2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B11&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">lookupL457</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B1&quot;</span><span class="p">),</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B3&quot;</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B4&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B5&quot;</span><span class="p">),</span>
            <span class="s2">&quot;T1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B6&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B7&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">lookupMOD09GQ</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b01&quot;</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b02&quot;</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">lookupMOD09GA</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b03&quot;</span><span class="p">),</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b04&quot;</span><span class="p">),</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b01&quot;</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b02&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b06&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;sur_refl_b07&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">lookupMCD43A4</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Nadir_Reflectance_Band3&quot;</span><span class="p">),</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Nadir_Reflectance_Band4&quot;</span><span class="p">),</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Nadir_Reflectance_Band1&quot;</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Nadir_Reflectance_Band2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S1&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Nadir_Reflectance_Band6&quot;</span><span class="p">),</span>
            <span class="s2">&quot;S2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Nadir_Reflectance_Band7&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">lookupPlatform</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;COPERNICUS/S2&quot;</span><span class="p">:</span> <span class="n">lookupS2</span><span class="p">,</span>
        <span class="s2">&quot;COPERNICUS/S2_SR&quot;</span><span class="p">:</span> <span class="n">lookupS2</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">lookupL8</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LC08/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">lookupL8</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LE07/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">lookupL457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LE07/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">lookupL457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT05/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">lookupL457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT05/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">lookupL457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT04/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">lookupL457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT04/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">lookupL457</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09GQ&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GQ</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09GQ&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GQ</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09GA&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GA</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09GA&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GA</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09Q1&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GQ</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09Q1&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GQ</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09A1&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GA</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09A1&quot;</span><span class="p">:</span> <span class="n">lookupMOD09GA</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MCD43A4&quot;</span><span class="p">:</span> <span class="n">lookupMCD43A4</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lookupPlatform</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Sorry, satellite platform not supported for index computation!&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">lookupPlatform</span><span class="p">[</span><span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]](</span><span class="n">img</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_indices</span><span class="p">(</span><span class="n">online</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the dictionary of indices used for the index() method in ee.Image and ee.ImageCollection classes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    online : boolean</span>
<span class="sd">        Wheter to retrieve the most recent list of indices directly from the GitHub repository and not from the local copy.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">online</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;https://raw.githubusercontent.com/davemlz/awesome-ee-spectral-indices/main/output/spectral-indices-dict.json&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eemontDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
            <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;eemont&quot;</span><span class="p">,</span> <span class="s2">&quot;eemont.py&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eemontDir</span><span class="p">,</span> <span class="s2">&quot;data/spectral-indices-dict.json&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">indices</span><span class="p">[</span><span class="s2">&quot;SpectralIndices&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an ee.Image representing a kernel computed on bands [a] and [b].</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : ee.Image</span>
<span class="sd">        Image to compute the kernel on.</span>
<span class="sd">    lookup : dict</span>
<span class="sd">        Dictionary retrieved from _get_expression_map().</span>
<span class="sd">    kernel : str</span>
<span class="sd">        Kernel to use.</span>
<span class="sd">    sigma : str | float</span>
<span class="sd">        Length-scale parameter. Used for kernel = &#39;RBF&#39;.</span>
<span class="sd">    a : str</span>
<span class="sd">        Key of the first band to use.</span>
<span class="sd">    b : str</span>
<span class="sd">        Key of the second band to use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ee.Image</span>
<span class="sd">        Kernel image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lookupab</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">lookup</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">lookup</span><span class="p">[</span><span class="n">b</span><span class="p">]}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">lookupab</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">lookupab</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">lookupab</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">}</span>
        <span class="n">kernels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="s2">&quot;a * b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RBF&quot;</span><span class="p">:</span> <span class="s2">&quot;exp((-1.0 * (a - b) ** 2.0)/(2.0 * sigma ** 2.0))&quot;</span><span class="p">,</span>
            <span class="s2">&quot;poly&quot;</span><span class="p">:</span> <span class="s2">&quot;((a * b) + c) ** p&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">kernel</span><span class="p">],</span> <span class="n">lookup</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_none_dict</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes elements from a dictionary with None values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dictionary : dict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Curated dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newDictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">newDictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">newDictionary</span>


<span class="k">def</span> <span class="nf">_get_kernel_parameters</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the additional kernel parameters to compute kernel indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : ee.Image</span>
<span class="sd">        Image to compute the kernel parameters on.</span>
<span class="sd">    lookup : dict</span>
<span class="sd">        Dictionary retrieved from _get_expression_map().</span>
<span class="sd">    kernel : str</span>
<span class="sd">        Kernel to use.</span>
<span class="sd">    sigma : str | float</span>
<span class="sd">        Length-scale parameter. Used for kernel = &#39;RBF&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Kernel parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kernelParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kNN&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kNR&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kNB&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kNL&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kGG&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kGR&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kGB&quot;</span><span class="p">:</span> <span class="n">_get_kernel_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">kernelParameters</span>


<span class="k">def</span> <span class="nf">_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">online</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes one or more spectral indices (indices are added as bands) for an image oir image collection.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image to compute indices on. Must be scaled to [0,1]. Check the supported platforms in User Guide &gt; Spectral Indices &gt; Supported Platforms.</span>
<span class="sd">    index : string | list[string]</span>
<span class="sd">        Index or list of indices to compute.</span>
<span class="sd">    G : float</span>
<span class="sd">        Gain factor. Used just for index = &#39;EVI&#39;.</span>
<span class="sd">    C1 : float</span>
<span class="sd">        Coefficient 1 for the aerosol resistance term. Used just for index = &#39;EVI&#39;.</span>
<span class="sd">    C2 : float</span>
<span class="sd">        Coefficient 2 for the aerosol resistance term. Used just for index = &#39;EVI&#39;.</span>
<span class="sd">    L : float</span>
<span class="sd">        Canopy background adjustment. Used just for index = [&#39;EVI&#39;,&#39;SAVI&#39;].</span>
<span class="sd">    kernel : str</span>
<span class="sd">        Kernel used for kernel indices.</span>
<span class="sd">    sigma : str | float</span>
<span class="sd">        Length-scale parameter. Used for kernel = &#39;RBF&#39;. If str, this must be an expression including &#39;a&#39; and &#39;b&#39;. If numeric, this must be positive.</span>
<span class="sd">    p : float</span>
<span class="sd">        Kernel degree. Used for kernel = &#39;poly&#39;.</span>
<span class="sd">    c : float</span>
<span class="sd">        Free parameter that trades off the influence of higher-order versus lower-order terms. Used for kernel = &#39;poly&#39;. This must be greater than or equal to 0.</span>
<span class="sd">    online : boolean</span>
<span class="sd">        Wheter to retrieve the most recent list of indices directly from the GitHub repository and not from the local copy.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ee.Image | ee.ImageCollection</span>
<span class="sd">        Image (or Image Collection) with the computed spectral index, or indices, as new bands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">platformDict</span> <span class="o">=</span> <span class="n">_get_platform_STAC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[sigma] must be positive!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[p] and [c] must be positive!&quot;</span><span class="p">)</span>

    <span class="n">additionalParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">G</span><span class="p">),</span>
        <span class="s2">&quot;C1&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">C1</span><span class="p">),</span>
        <span class="s2">&quot;C2&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">C2</span><span class="p">),</span>
        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">L</span><span class="p">),</span>
        <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">spectralIndices</span> <span class="o">=</span> <span class="n">_get_indices</span><span class="p">(</span><span class="n">online</span><span class="p">)</span>
    <span class="n">indicesNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectralIndices</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectralIndices</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vegetation&quot;</span><span class="p">,</span> <span class="s2">&quot;burn&quot;</span><span class="p">,</span> <span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="s2">&quot;snow&quot;</span><span class="p">,</span> <span class="s2">&quot;drought&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">]:</span>
            <span class="n">temporalListOfIndices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indicesNames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spectralIndices</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                    <span class="n">temporalListOfIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">temporalListOfIndices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectralIndices</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Index &quot;</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">+</span> <span class="s2">&quot; is not a built-in index and it won&#39;t be computed!&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">temporalIndex</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
                <span class="n">lookupDic</span> <span class="o">=</span> <span class="n">_get_expression_map</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">platformDict</span><span class="p">)</span>
                <span class="n">lookupDic</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">lookupDic</span><span class="p">,</span> <span class="o">**</span><span class="n">additionalParameters</span><span class="p">}</span>
                <span class="n">kernelParameters</span> <span class="o">=</span> <span class="n">_get_kernel_parameters</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lookupDic</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
                <span class="n">lookupDic</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">lookupDic</span><span class="p">,</span> <span class="o">**</span><span class="n">kernelParameters</span><span class="p">}</span>
                <span class="n">lookupDicCurated</span> <span class="o">=</span> <span class="n">_remove_none_dict</span><span class="p">(</span><span class="n">lookupDic</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">band</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lookupDicCurated</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">spectralIndices</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span>
                            <span class="n">spectralIndices</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;formula&quot;</span><span class="p">],</span> <span class="n">lookupDicCurated</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;This platform doesn&#39;t have the required bands for &quot;</span>
                        <span class="o">+</span> <span class="n">idx</span>
                        <span class="o">+</span> <span class="s2">&quot; computation!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">img</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">imagecollection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">):</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">temporalIndex</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="n">temporalIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="indices"><a class="viewcode-back" href="../../modules/common.html#eemont.common.indices">[docs]</a><span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="n">online</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the dictionary of available indices as a Box object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    online : boolean</span>
<span class="sd">        Wheter to retrieve the most recent list of indices directly from the GitHub repository and not from the local copy.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Box</span>
<span class="sd">        Dictionary of available indices. For each index, the keys &#39;short_name&#39;, &#39;long_name&#39;, &#39;formula&#39;, &#39;bands&#39;, &#39;reference&#39;, &#39;type&#39;, &#39;date_of_addition&#39; and &#39;contributor&#39; can be checked.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    listIndices : Gets the list of available indices.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import eemont</span>
<span class="sd">    &gt;&gt;&gt; indices = eemont.indices()</span>
<span class="sd">    &gt;&gt;&gt; indices.BAIS2.long_name</span>
<span class="sd">    &#39;Burned Area Index for Sentinel 2&#39;</span>
<span class="sd">    &gt;&gt;&gt; indices.BAIS2.formula</span>
<span class="sd">    &#39;(1.0 - ((RE2 * RE3 * RE4) / R) ** 0.5) * (((S2 - RE4)/(S2 + RE4) ** 0.5) + 1.0)&#39;</span>
<span class="sd">    &gt;&gt;&gt; indices.BAIS2.reference</span>
<span class="sd">    &#39;https://doi.org/10.3390/ecrs-2-05177&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">_get_indices</span><span class="p">(</span><span class="n">online</span><span class="p">),</span> <span class="n">frozen_box</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="listIndices"><a class="viewcode-back" href="../../modules/common.html#eemont.common.listIndices">[docs]</a><span class="k">def</span> <span class="nf">listIndices</span><span class="p">(</span><span class="n">online</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the list of available indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    online : boolean</span>
<span class="sd">        Wheter to retrieve the most recent list of indices directly from the GitHub repository and not from the local copy.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of available indices.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    indices : Gets the dictionary of available indices as a Box object.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import eemont</span>
<span class="sd">    &gt;&gt;&gt; eemont.listIndices()</span>
<span class="sd">    [&#39;BNDVI&#39;,&#39;CIG&#39;,&#39;CVI&#39;,&#39;EVI&#39;,&#39;EVI2&#39;,&#39;GBNDVI&#39;,&#39;GNDVI&#39;,...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_get_indices</span><span class="p">(</span><span class="n">online</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<span class="c1"># Image Scaling</span>
<span class="c1"># --------------------------</span>


<span class="k">def</span> <span class="nf">_get_scale_params</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the scale parameters for each band of the image or image collection.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image or image collection to get the scale parameters from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with the scale parameters for each band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">platformDict</span> <span class="o">=</span> <span class="n">_get_platform_STAC</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">eemontDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;eemont&quot;</span><span class="p">,</span> <span class="s2">&quot;eemont.py&quot;</span><span class="p">))</span>
    <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eemontDir</span><span class="p">,</span> <span class="s2">&quot;data/ee-catalog-scale.json&quot;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">)</span>
    <span class="n">eeDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">platforms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This platform is not supported for getting scale parameters.&quot;</span><span class="p">)</span>   
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eeDict</span><span class="p">[</span><span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]]</span>
    

<span class="k">def</span> <span class="nf">_get_offset_params</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the offset parameters for each band of the image or image collection.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image or image collection to get the offset parameters from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with the offset parameters for each band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">platformDict</span> <span class="o">=</span> <span class="n">_get_platform_STAC</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">eemontDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;eemont&quot;</span><span class="p">,</span> <span class="s2">&quot;eemont.py&quot;</span><span class="p">))</span>
    <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eemontDir</span><span class="p">,</span> <span class="s2">&quot;data/ee-catalog-offset.json&quot;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">)</span>
    <span class="n">eeDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">platforms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This platform is not supported for getting offset parameters.&quot;</span><span class="p">)</span>   
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eeDict</span><span class="p">[</span><span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">_scale_STAC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scales bands on an image or image collection.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image or iage collection to scale.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ee.Image | ee.ImageCollection</span>
<span class="sd">        Scaled image or image collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scaleParams</span> <span class="o">=</span> <span class="n">_get_scale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">offsetParams</span> <span class="o">=</span> <span class="n">_get_offset_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">scaleParams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offsetParams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This platform is not supported for scaling and offsetting.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">scaleParams</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">scaleParams</span><span class="p">)</span><span class="o">.</span><span class="n">toImage</span><span class="p">()</span>
        <span class="n">offsetParams</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">offsetParams</span><span class="p">)</span><span class="o">.</span><span class="n">toImage</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">scaleOffset</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
            <span class="n">scaleList</span> <span class="o">=</span> <span class="n">scaleParams</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">inList</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="n">scaleList</span><span class="p">))</span>
            <span class="n">SOscaleParams</span> <span class="o">=</span> <span class="n">scaleParams</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">SOoffsetParams</span> <span class="o">=</span> <span class="n">offsetParams</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">scaled</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">SOscaleParams</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">SOoffsetParams</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">()))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">scaled</span> <span class="o">=</span> <span class="n">scaleOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">imagecollection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">):</span>
            <span class="n">scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">scaleOffset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scaled</span>


<span class="c1"># Cloud Masking</span>
<span class="c1"># --------------------------</span>


<span class="k">def</span> <span class="nf">_maskClouds</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">,</span>
    <span class="n">prob</span><span class="p">,</span>
    <span class="n">maskCirrus</span><span class="p">,</span>
    <span class="n">maskShadows</span><span class="p">,</span>
    <span class="n">scaledImage</span><span class="p">,</span>
    <span class="n">dark</span><span class="p">,</span>
    <span class="n">cloudDist</span><span class="p">,</span>
    <span class="n">buffer</span><span class="p">,</span>
    <span class="n">cdi</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Masks clouds and shadows in an image or image collection (valid just for Surface Reflectance products).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image or image collection to mask.</span>
<span class="sd">    method : string, default = &#39;cloud_prob&#39;</span>
<span class="sd">        Method used to mask clouds.\n</span>
<span class="sd">        Available options:</span>
<span class="sd">            - &#39;cloud_prob&#39; : Use cloud probability.</span>
<span class="sd">            - &#39;qa&#39; : Use Quality Assessment band.</span>
<span class="sd">        This parameter is ignored for Landsat products.</span>
<span class="sd">    prob : numeric [0, 100], default = 60</span>
<span class="sd">        Cloud probability threshold. Valid just for method = &#39;prob&#39;. This parameter is ignored for Landsat products.</span>
<span class="sd">    maskCirrus : boolean, default = True</span>
<span class="sd">        Whether to mask cirrus clouds. Valid just for method = &#39;qa&#39;. This parameter is ignored for Landsat products.</span>
<span class="sd">    maskShadows : boolean, default = True</span>
<span class="sd">        Whether to mask cloud shadows. For more info see &#39;Braaten, J. 2020. Sentinel-2 Cloud Masking with s2cloudless. Google Earth Engine, Community Tutorials&#39;.</span>
<span class="sd">    scaledImage : boolean, default = False</span>
<span class="sd">        Whether the pixel values are scaled to the range [0,1] (reflectance values). This parameter is ignored for Landsat products.</span>
<span class="sd">    dark : float [0,1], default = 0.15</span>
<span class="sd">        NIR threshold. NIR values below this threshold are potential cloud shadows. This parameter is ignored for Landsat products.</span>
<span class="sd">    cloudDist : int, default = 1000</span>
<span class="sd">        Maximum distance in meters (m) to look for cloud shadows from cloud edges. This parameter is ignored for Landsat products.</span>
<span class="sd">    buffer : int, default = 250</span>
<span class="sd">        Distance in meters (m) to dilate cloud and cloud shadows objects. This parameter is ignored for Landsat products.</span>
<span class="sd">    cdi : float [-1,1], default = None</span>
<span class="sd">        Cloud Displacement Index threshold. Values below this threshold are considered potential clouds.</span>
<span class="sd">        A cdi = None means that the index is not used. For more info see &#39;Frantz, D., HaS, E., Uhl, A., Stoffels, J., Hill, J. 2018. Improvement of the Fmask algorithm for Sentinel-2 images:</span>
<span class="sd">        Separating clouds from bright surfaces based on parallax effects. Remote Sensing of Environment 2015: 471-481&#39;.</span>
<span class="sd">        This parameter is ignored for Landsat products.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ee.Image | ee.ImageCollection</span>
<span class="sd">        Cloud-shadow masked image or image collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">S3</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;quality_flags&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">S2</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">cloud_prob</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">clouds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cloud_mask&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;probability&quot;</span><span class="p">)</span>
            <span class="n">isCloud</span> <span class="o">=</span> <span class="n">clouds</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;CLOUD_MASK&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">isCloud</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">QA</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">qa</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;QA60&quot;</span><span class="p">)</span>
            <span class="n">cloudBitMask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
            <span class="n">isCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">cloudBitMask</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maskCirrus</span><span class="p">:</span>
                <span class="n">cirrusBitMask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
                <span class="n">isCloud</span> <span class="o">=</span> <span class="n">isCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">cirrusBitMask</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">isCloud</span> <span class="o">=</span> <span class="n">isCloud</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;CLOUD_MASK&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">isCloud</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">CDI</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">)</span>
            <span class="n">S2TOA</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;COPERNICUS/S2&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s2">&quot;system:index&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">CloudDisplacementIndex</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">Sentinel2</span><span class="o">.</span><span class="n">CDI</span><span class="p">(</span><span class="n">S2TOA</span><span class="p">)</span>
            <span class="n">isCloud</span> <span class="o">=</span> <span class="n">CloudDisplacementIndex</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">cdi</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;CLOUD_MASK_CDI&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">isCloud</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_shadows</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">notWater</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SCL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scaledImage</span><span class="p">:</span>
                <span class="n">darkPixels</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">dark</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">notWater</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">darkPixels</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;B8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">dark</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">notWater</span><span class="p">)</span>
            <span class="n">shadowAzimuth</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MEAN_SOLAR_AZIMUTH_ANGLE&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">cloudProjection</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;CLOUD_MASK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">directionalDistanceTransform</span><span class="p">(</span>
                <span class="n">shadowAzimuth</span><span class="p">,</span> <span class="n">cloudDist</span> <span class="o">/</span> <span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">cloudProjection</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cloudProjection</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">projection</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mask</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">isShadow</span> <span class="o">=</span> <span class="n">cloudProjection</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">darkPixels</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;SHADOW_MASK&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">isShadow</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">clean_dilate</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="n">isCloudShadow</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;CLOUD_MASK&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cdi</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">isCloudShadow</span> <span class="o">=</span> <span class="n">isCloudShadow</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;CLOUD_MASK_CDI&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
                <span class="n">isCloudShadow</span> <span class="o">=</span> <span class="n">isCloudShadow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SHADOW_MASK&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">isCloudShadow</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">isCloudShadow</span><span class="o">.</span><span class="n">focal_min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;meters&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">buffer</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;meters&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;CLOUD_SHADOW_MASK&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">isCloudShadow</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">apply_mask</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;CLOUD_SHADOW_MASK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cloud_prob&quot;</span><span class="p">:</span>
                <span class="n">S2Clouds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;COPERNICUS/S2_CLOUD_PROBABILITY&quot;</span><span class="p">)</span>
                <span class="n">fil</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
                    <span class="n">leftField</span><span class="o">=</span><span class="s2">&quot;system:index&quot;</span><span class="p">,</span> <span class="n">rightField</span><span class="o">=</span><span class="s2">&quot;system:index&quot;</span>
                <span class="p">)</span>
                <span class="n">S2WithCloudMask</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">saveFirst</span><span class="p">(</span><span class="s2">&quot;cloud_mask&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">S2Clouds</span><span class="p">,</span> <span class="n">fil</span>
                <span class="p">)</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">S2WithCloudMask</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cloud_prob</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;qa&quot;</span><span class="p">:</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">QA</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cdi</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">CDI</span><span class="p">(</span><span class="n">S2Masked</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">get_shadows</span><span class="p">(</span><span class="n">S2Masked</span><span class="p">)</span>
            <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">clean_dilate</span><span class="p">(</span><span class="n">S2Masked</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">imagecollection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cloud_prob&quot;</span><span class="p">:</span>
                <span class="n">S2Clouds</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;COPERNICUS/S2_CLOUD_PROBABILITY&quot;</span><span class="p">)</span>
                <span class="n">fil</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
                    <span class="n">leftField</span><span class="o">=</span><span class="s2">&quot;system:index&quot;</span><span class="p">,</span> <span class="n">rightField</span><span class="o">=</span><span class="s2">&quot;system:index&quot;</span>
                <span class="p">)</span>
                <span class="n">S2WithCloudMask</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Join</span><span class="o">.</span><span class="n">saveFirst</span><span class="p">(</span><span class="s2">&quot;cloud_mask&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="n">args</span><span class="p">,</span> <span class="n">S2Clouds</span><span class="p">,</span> <span class="n">fil</span>
                <span class="p">)</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">S2WithCloudMask</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cloud_prob</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;qa&quot;</span><span class="p">:</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">QA</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cdi</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">S2Masked</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">CDI</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
                <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">S2Masked</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_shadows</span><span class="p">)</span>
            <span class="n">S2Masked</span> <span class="o">=</span> <span class="n">S2Masked</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">clean_dilate</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">S2Masked</span>

    <span class="k">def</span> <span class="nf">L8</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">cloudsBitMask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;pixel_qa&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">cloudsBitMask</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">cloudShadowBitMask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="n">cloudShadowBitMask</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">L457</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;pixel_qa&quot;</span><span class="p">)</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">cloud</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">mask</span><span class="p">()</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD09GA</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;state_1km&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">maskCirrus</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MCD15A3H</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;FparExtra_QC&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">maskCirrus</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD09Q1</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">maskCirrus</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD09A1</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;StateQA&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">maskCirrus</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD17A2H</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Psn_QC&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD16A2</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;ET_QC&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD13Q1A1</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SummaryQA&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MOD13A2</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SummaryQA&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">VNP09GA</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qf1</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;QF1&quot;</span><span class="p">)</span>
        <span class="n">qf2</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;QF2&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qf1</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qf2</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">maskCirrus</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qf2</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qf2</span><span class="o">.</span><span class="n">bitwiseAnd</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">VNP13A1</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;pixel_reliability&quot;</span><span class="p">)</span>
        <span class="n">notCloud</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maskShadows</span><span class="p">:</span>
            <span class="n">notCloud</span> <span class="o">=</span> <span class="n">notCloud</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">notCloud</span><span class="p">)</span>

    <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;COPERNICUS/S3/OLCI&quot;</span><span class="p">:</span> <span class="n">S3</span><span class="p">,</span>
        <span class="s2">&quot;COPERNICUS/S2_SR&quot;</span><span class="p">:</span> <span class="n">S2</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LC08/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">L8</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LC08/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">L8</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LE07/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">L457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LE07/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">L457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT05/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">L457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT05/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">L457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT04/C01/T1_SR&quot;</span><span class="p">:</span> <span class="n">L457</span><span class="p">,</span>
        <span class="s2">&quot;LANDSAT/LT04/C01/T2_SR&quot;</span><span class="p">:</span> <span class="n">L457</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09GA&quot;</span><span class="p">:</span> <span class="n">MOD09GA</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MCD15A3H&quot;</span><span class="p">:</span> <span class="n">MCD15A3H</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09Q1&quot;</span><span class="p">:</span> <span class="n">MOD09Q1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD09A1&quot;</span><span class="p">:</span> <span class="n">MOD09A1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD17A2H&quot;</span><span class="p">:</span> <span class="n">MOD17A2H</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD16A2&quot;</span><span class="p">:</span> <span class="n">MOD16A2</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD13Q1&quot;</span><span class="p">:</span> <span class="n">MOD13Q1A1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD13A1&quot;</span><span class="p">:</span> <span class="n">MOD13Q1A1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MOD13A2&quot;</span><span class="p">:</span> <span class="n">MOD13A2</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09GA&quot;</span><span class="p">:</span> <span class="n">MOD09GA</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09Q1&quot;</span><span class="p">:</span> <span class="n">MOD09Q1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD09A1&quot;</span><span class="p">:</span> <span class="n">MOD09A1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD17A2H&quot;</span><span class="p">:</span> <span class="n">MOD17A2H</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD16A2&quot;</span><span class="p">:</span> <span class="n">MOD16A2</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD13Q1&quot;</span><span class="p">:</span> <span class="n">MOD13Q1A1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD13A1&quot;</span><span class="p">:</span> <span class="n">MOD13Q1A1</span><span class="p">,</span>
        <span class="s2">&quot;MODIS/006/MYD13A2&quot;</span><span class="p">:</span> <span class="n">MOD13A2</span><span class="p">,</span>
        <span class="s2">&quot;NOAA/VIIRS/001/VNP09GA&quot;</span><span class="p">:</span> <span class="n">VNP09GA</span><span class="p">,</span>
        <span class="s2">&quot;NOAA/VIIRS/001/VNP13A1&quot;</span><span class="p">:</span> <span class="n">VNP13A1</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">platformDict</span> <span class="o">=</span> <span class="n">_get_platform_STAC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This platform is not supported for cloud masking.&quot;</span><span class="p">)</span>        
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">else</span><span class="p">:</span>      
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">masked</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]](</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">imagecollection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COPERNICUS/S2_SR&quot;</span><span class="p">:</span>
                <span class="n">masked</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]](</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lookup</span><span class="p">[</span><span class="n">platformDict</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">masked</span>

<span class="c1"># Preprocessing</span>
<span class="c1"># --------------------------</span>

<span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pre-process the image, or image collection: masks clouds and shadows, and scales and offsets the image, or image collection. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : ee.Image | ee.ImageCollection</span>
<span class="sd">        Image or Image Collection to pre-process.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        Keywords arguments for maskClouds().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ee.Image | ee.ImageCollection</span>
<span class="sd">        Pre-processed image or image collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maskCloudsDefault</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;cloud_prob&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prob&quot;</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;maskCirrus&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;maskShadows&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;scaledImage&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;dark&quot;</span><span class="p">:</span><span class="mf">0.15</span><span class="p">,</span>
        <span class="s2">&quot;cloudDist&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;buffer&quot;</span><span class="p">:</span><span class="mi">250</span><span class="p">,</span>
        <span class="s2">&quot;cdi&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">maskCloudsDefault</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
    <span class="bp">self</span> <span class="o">=</span> <span class="n">_maskClouds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">_scale_STAC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="bp">self</span>
    
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../_static/js/index.1e043a052b0af929e4d8.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2021, David Montero Loaiza.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>